<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Stream - OBS Actions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: transparent;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .obs-status {
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #333;
        }
        
        .obs-status.connected {
            border-color: #4CAF50;
        }
        
        .obs-status.error {
            border-color: #f44336;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
            margin-right: 8px;
        }
        
        .status-indicator.connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .warning-box {
            background: #ff9800;
            color: #000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .warning-box h3 {
            margin-bottom: 10px;
        }
        
        .obs-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .control-button {
            padding: 15px 20px;
            background: #8A2BE2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-button:hover {
            background: #A450F0;
            transform: translateY(-2px);
        }
        
        .control-button:active {
            transform: translateY(0);
        }
        
        .control-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .scene-selector {
            margin: 20px 0;
        }
        
        .scene-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .scene-selector input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            border-radius: 4px;
            color: white;
            font-size: 16px;
        }
        
        .log-container {
            margin-top: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-entry.error {
            color: #f44336;
        }
        
        .log-entry.success {
            color: #4CAF50;
        }
        
        .log-entry.warning {
            color: #ff9800;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="obs-status" id="obsStatus">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Checking OBS Browser Source API...</span>
        </div>
        
        <div class="warning-box" id="warningBox">
            <h3>⚠️ OBS Browser Source Configuration Required</h3>
            <p>To use these controls, your OBS Browser Source must have:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Access to OBS API: <strong>Advanced</strong></li>
                <li>Page permissions: <strong>Advanced Access Level</strong></li>
                <li>Allow right click menu: <strong>Enabled</strong> (for debugging)</li>
            </ul>
            <p style="margin-top: 10px;">Right-click the Browser Source → Properties → Advanced to configure.</p>
        </div>
        
        <div class="obs-controls" id="obsControls">
            <div class="scene-selector">
                <label for="sceneNameInput">Scene Name:</label>
                <input type="text" id="sceneNameInput" placeholder="Enter scene name (e.g., Game Scene)">
            </div>
            
            <button class="control-button" id="changeSceneBtn">Change Scene</button>
            <button class="control-button" id="startRecordingBtn">Start Recording</button>
            <button class="control-button" id="stopRecordingBtn">Stop Recording</button>
            <button class="control-button" id="startStreamingBtn">Start Streaming</button>
            <button class="control-button" id="stopStreamingBtn">Stop Streaming</button>
            <button class="control-button" id="saveReplayBtn">Save Replay Buffer</button>
        </div>
        
        <div class="log-container">
            <h3>Activity Log</h3>
            <div id="logEntries"></div>
        </div>
    </div>
    
    <script>
        // OBS Browser Source API interface
        class OBSController {
            constructor() {
                this.isAvailable = false;
                this.init();
            }
            
            init() {
                // Check if OBS Browser Source API is available
                if (typeof window.obsstudio !== 'undefined') {
                    this.isAvailable = true;
                    this.updateStatus(true, 'OBS Browser Source API Connected');
                    this.log('OBS Browser Source API detected and ready', 'success');
                    
                    // Register visibility callback if available
                    if (window.obsstudio.onVisibilityChange) {
                        window.obsstudio.onVisibilityChange = (visible) => {
                            this.log(`Source visibility changed: ${visible ? 'Visible' : 'Hidden'}`, 'info');
                        };
                    }
                    
                    // Register active/inactive callback if available
                    if (window.obsstudio.onActiveChange) {
                        window.obsstudio.onActiveChange = (active) => {
                            this.log(`Source active state changed: ${active ? 'Active' : 'Inactive'}`, 'info');
                        };
                    }
                } else {
                    this.updateStatus(false, 'OBS Browser Source API Not Available');
                    this.log('OBS Browser Source API not detected. Make sure this page is loaded in OBS Browser Source with proper permissions.', 'error');
                }
            }
            
            updateStatus(connected, text) {
                const statusEl = document.getElementById('obsStatus');
                const indicatorEl = document.getElementById('statusIndicator');
                const textEl = document.getElementById('statusText');
                
                if (connected) {
                    statusEl.classList.add('connected');
                    indicatorEl.classList.add('connected');
                    document.getElementById('warningBox').classList.add('hidden');
                } else {
                    statusEl.classList.add('error');
                    indicatorEl.classList.remove('connected');
                }
                
                textEl.textContent = text;
            }
            
            log(message, type = 'info') {
                const logContainer = document.getElementById('logEntries');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                
                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${message}`;
                
                logContainer.insertBefore(entry, logContainer.firstChild);
                
                // Keep only last 50 entries
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.lastChild);
                }
                
                // Also log to console
                console.log(`[OBS Controller] ${message}`);
            }
            
            changeScene(sceneName) {
                if (!this.isAvailable) {
                    this.log('Cannot change scene: OBS API not available', 'error');
                    return;
                }
                
                if (!sceneName) {
                    this.log('Scene name is required', 'warning');
                    return;
                }
                
                try {
                    window.obsstudio.setCurrentScene(sceneName);
                    this.log(`Changed scene to: ${sceneName}`, 'success');
                } catch (error) {
                    this.log(`Error changing scene: ${error.message}`, 'error');
                }
            }
            
            startRecording() {
                if (!this.isAvailable) {
                    this.log('Cannot start recording: OBS API not available', 'error');
                    return;
                }
                
                try {
                    window.obsstudio.startRecording();
                    this.log('Recording started', 'success');
                } catch (error) {
                    this.log(`Error starting recording: ${error.message}`, 'error');
                }
            }
            
            stopRecording() {
                if (!this.isAvailable) {
                    this.log('Cannot stop recording: OBS API not available', 'error');
                    return;
                }
                
                try {
                    window.obsstudio.stopRecording();
                    this.log('Recording stopped', 'success');
                } catch (error) {
                    this.log(`Error stopping recording: ${error.message}`, 'error');
                }
            }
            
            startStreaming() {
                if (!this.isAvailable) {
                    this.log('Cannot start streaming: OBS API not available', 'error');
                    return;
                }
                
                try {
                    window.obsstudio.startStreaming();
                    this.log('Streaming started', 'success');
                } catch (error) {
                    this.log(`Error starting streaming: ${error.message}`, 'error');
                }
            }
            
            stopStreaming() {
                if (!this.isAvailable) {
                    this.log('Cannot stop streaming: OBS API not available', 'error');
                    return;
                }
                
                try {
                    window.obsstudio.stopStreaming();
                    this.log('Streaming stopped', 'success');
                } catch (error) {
                    this.log(`Error stopping streaming: ${error.message}`, 'error');
                }
            }
            
            saveReplayBuffer() {
                if (!this.isAvailable) {
                    this.log('Cannot save replay buffer: OBS API not available', 'error');
                    return;
                }
                
                try {
                    window.obsstudio.saveReplayBuffer();
                    this.log('Replay buffer saved', 'success');
                } catch (error) {
                    this.log(`Error saving replay buffer: ${error.message}`, 'error');
                }
            }
        }
        
        // Initialize OBS Controller
        const obsController = new OBSController();
        
        // Set up button event listeners
        document.getElementById('changeSceneBtn').addEventListener('click', () => {
            const sceneName = document.getElementById('sceneNameInput').value;
            obsController.changeScene(sceneName);
        });
        
        document.getElementById('startRecordingBtn').addEventListener('click', () => {
            obsController.startRecording();
        });
        
        document.getElementById('stopRecordingBtn').addEventListener('click', () => {
            obsController.stopRecording();
        });
        
        document.getElementById('startStreamingBtn').addEventListener('click', () => {
            obsController.startStreaming();
        });
        
        document.getElementById('stopStreamingBtn').addEventListener('click', () => {
            obsController.stopStreaming();
        });
        
        document.getElementById('saveReplayBtn').addEventListener('click', () => {
            obsController.saveReplayBuffer();
        });
        
        // Listen for messages from parent window (Event Flow System integration)
        window.addEventListener('message', (event) => {
            // Validate origin if needed
            // if (event.origin !== 'expected-origin') return;
            
            const data = event.data;
            if (data && data.action) {
                obsController.log(`Received action from Event Flow: ${data.action}`, 'info');
                
                switch (data.action) {
                    case 'obsChangeScene':
                        obsController.changeScene(data.sceneName);
                        break;
                    case 'obsStartRecording':
                        obsController.startRecording();
                        break;
                    case 'obsStopRecording':
                        obsController.stopRecording();
                        break;
                    case 'obsStartStreaming':
                        obsController.startStreaming();
                        break;
                    case 'obsStopStreaming':
                        obsController.stopStreaming();
                        break;
                    case 'obsReplayBuffer':
                        obsController.saveReplayBuffer();
                        break;
                    default:
                        obsController.log(`Unknown action: ${data.action}`, 'warning');
                }
            }
        });
        
        // Log initial state
        obsController.log('OBS Actions page loaded and ready', 'info');
    </script>
</body>
</html>